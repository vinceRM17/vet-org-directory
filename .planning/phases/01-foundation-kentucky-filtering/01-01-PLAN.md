---
phase: 01-foundation-kentucky-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - extractors/nodc.py
autonomous: true

must_haves:
  truths:
    - "NODC extractor downloads concordance and BMF data from working GitHub URLs"
    - "NODC extractor filters downloaded data to matching EINs and returns non-empty DataFrame"
    - "Pipeline Stage 4 completes without errors when NODC extractor runs"
  artifacts:
    - path: "extractors/nodc.py"
      provides: "NODC extractor with verified working GitHub URLs"
      contains: "CONCORDANCE_URL"
  key_links:
    - from: "extractors/nodc.py"
      to: "GitHub raw URLs"
      via: "requests.get in RateLimitedSession"
      pattern: "raw\\.githubusercontent\\.com.*Nonprofit-Open-Data-Collective"
---

<objective>
Fix the NODC (Nonprofit Open Data Collective) extractor so it successfully downloads and merges nonprofit data from GitHub.

Purpose: The NODC extractor's GitHub CSV URLs are broken because the upstream repos have reorganized. This blocks Stage 4 of the pipeline from contributing NODC data (mission statements, employee/volunteer counts) to the directory. Fixing this is a prerequisite for complete data enrichment.

Output: Working `extractors/nodc.py` that successfully downloads concordance and BMF data from verified GitHub URLs.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@extractors/nodc.py
@utils/http_client.py
@config/settings.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Probe and fix NODC GitHub URLs in extractor</name>
  <files>extractors/nodc.py</files>
  <action>
The NODC extractor at `extractors/nodc.py` has broken GitHub URLs. The concordance file was renamed from `efiler_master_concordance.csv` to `concordance.csv`, and the BMF CSV location is unclear.

1. **Probe current URLs** using Python `requests.head()` to test which URLs return 200:
   - Concordance: `https://raw.githubusercontent.com/Nonprofit-Open-Data-Collective/irs-efile-master-concordance-file/master/concordance.csv`
   - BMF data candidates:
     - `https://raw.githubusercontent.com/Nonprofit-Open-Data-Collective/irs-exempt-org-business-master-file/master/data/bmf-master.csv`
     - `https://raw.githubusercontent.com/Nonprofit-Open-Data-Collective/irs-exempt-org-business-master-file/master/bmf-master.csv`
     - `https://raw.githubusercontent.com/Nonprofit-Open-Data-Collective/irs-efile-master-concordance-file/master/990_master.csv`
   - Also try `main` branch instead of `master` for each URL (GitHub default branch naming migration)
   - If none of the known URLs work, browse the GitHub repos via web to find the actual file paths:
     - `https://github.com/Nonprofit-Open-Data-Collective/irs-efile-master-concordance-file`
     - `https://github.com/Nonprofit-Open-Data-Collective/irs-exempt-org-business-master-file`

2. **Update `extractors/nodc.py`** with verified working URLs:
   - Update `NODC_BASE` and `CONCORDANCE_URL` constants at the top of the file
   - Update `NODC_BMF_REPO` constant
   - Update the `data_urls` list in the `extract()` method to include all verified working URL patterns
   - Include both `master` and `main` branch variants in the URL probe list for resilience
   - Keep the existing try/except fallback pattern that iterates through `data_urls`

3. **Test the fix** by running the NODC extractor in isolation:
   ```python
   python3 -c "
   from extractors.nodc import NodcExtractor
   ext = NodcExtractor()
   df = ext.extract()
   print(f'Rows: {len(df)}, Columns: {list(df.columns)[:10]}')
   if len(df) > 0:
       print('SUCCESS: NODC extractor returned data')
   else:
       print('WARNING: NODC extractor returned empty DataFrame')
   "
   ```

Important: The extractor already has good fallback logic (try multiple URLs). The fix is about ensuring at least one URL in each list actually works. Do NOT change the architecture -- just fix the URLs.
  </action>
  <verify>
Run the NODC extractor and confirm it returns a non-empty DataFrame:
```bash
cd /Users/vincecain/Projects/vet_org_directory
python3 -c "
from extractors.nodc import NodcExtractor
ext = NodcExtractor()
df = ext.extract()
print(f'Rows: {len(df)}')
assert len(df) > 0, 'NODC extractor returned empty DataFrame'
print('PASS: NODC extractor works')
"
```

Also verify the concordance file downloads:
```bash
python3 -c "
from config.settings import RAW_DIR
path = RAW_DIR / 'nodc_concordance.csv'
assert path.exists(), 'Concordance file not downloaded'
import pandas as pd
df = pd.read_csv(path, nrows=5)
print(f'Concordance columns: {list(df.columns)[:5]}')
print('PASS: Concordance file downloaded')
"
```

If the upstream GitHub repos have completely removed the data files (no URL works), document this finding and update the extractor to log a clear message explaining the situation. In that case, the extractor should gracefully return an empty DataFrame (which it already does).
  </verify>
  <done>
NODC extractor's GitHub URLs are verified and updated. Running `NodcExtractor().extract()` either returns data from NODC GitHub repos OR gracefully returns empty DataFrame with clear log message explaining which URLs were tried and their status codes. The `data_urls` list includes both `master` and `main` branch variants for resilience against GitHub branch renaming.
  </done>
</task>

</tasks>

<verification>
1. `extractors/nodc.py` contains updated, verified GitHub URLs
2. Running `python3 -c "from extractors.nodc import NodcExtractor; df = NodcExtractor().extract(); print(len(df))"` completes without errors
3. The extractor logs which URLs it tried and their outcomes
4. URL fallback list includes both `master` and `main` branch variants
</verification>

<success_criteria>
- NODC extractor runs without HTTP errors on verified URLs
- Concordance file downloads successfully (or logs clear reason why not)
- BMF data file downloads and parses into DataFrame (or logs clear reason why not)
- Existing fallback/retry architecture is preserved
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-kentucky-filtering/01-01-SUMMARY.md`
</output>
